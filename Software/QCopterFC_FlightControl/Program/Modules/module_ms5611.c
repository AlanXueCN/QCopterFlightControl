/*=====================================================================================================*/
/*=====================================================================================================*/
#include "stm32f4_system.h"
#include "stm32f4_i2c.h"
#include "module_ms5611.h"
/*=====================================================================================================*/
/*=====================================================================================================*/
static MS5611_ST COEFF;
/*=====================================================================================================*/
/*=====================================================================================================*
**函數 : MS5611_Init
**功能 : 初始化MS5611
**輸入 : COEFF
**輸出 : None
**使用 : MS5611_Init();
**=====================================================================================================*/
/*=====================================================================================================*/
void MS5611_Init( void )
{
  u8 WriteCMD = MS5611_RESET;

  /* Reset */
  I2C_WriteByte(MS5611_I2C_ADDR, &WriteCMD, 1);
  Delay_1ms(10);

  /* Read PROM */
  MS5611_ReadPROM();
  Delay_1ms(10);

  /* D1, D2 Conversion */
  MS5611_ConvADC(MS5611_D1_OSR_4096);
  Delay_1ms(10);
  MS5611_ReadADC(MS5611_ADC_D1);

  MS5611_ConvADC(MS5611_D2_OSR_4096);
  Delay_1ms(10);
  MS5611_ReadADC(MS5611_ADC_D2);

  /* Calculate */
  MS5611_Calculate();
}
/*=====================================================================================================*/
/*=====================================================================================================*
**函數 : MS5611_ReadPROM
**功能 : Read PROM
**輸入 : COEFF
**輸出 : None
**使用 : MS5611_ReadPROM();
**=====================================================================================================*/
/*=====================================================================================================*/
static void MS5611_ReadPROM( void )
{
  u8 i = 0;
  u8 WriteCMD = 0;
  u8 ReadC[6][2] = {0};

  for(i=0; i<6; i++) {
    WriteCMD = MS5611_PROM_COEFF_1+i;
    I2C_WriteByte(MS5611_I2C_ADDR, &WriteCMD, 1);
    I2C_ReadByte(MS5611_I2C_ADDR, ReadC[i], 2);
    COEFF.C[i+1] = (u16)((ReadC[i][0] << 8) | ReadC[i][1]);
  }
}
/*=====================================================================================================*/
/*=====================================================================================================*
**函數 : MS5611_ConvADC
**功能 : Convert ADC
**輸入 : ADC_ConvMode
**輸出 : None
**使用 : MS5611_ConvADC(MS5611_D1_OSR_4096);
**=====================================================================================================*/
/*=====================================================================================================*/
static void MS5611_ConvADC( u8 ADC_ConvMode )
{
  u8 WriteCMD = ADC_ConvMode;

  I2C_WriteByte(MS5611_I2C_ADDR, &WriteCMD, 1);
}
/*=====================================================================================================*/
/*=====================================================================================================*
**函數 : MS5611_ReadADC
**功能 : Read ADC
**輸入 : COEFF, ADC_Sel
**輸出 : None
**使用 : MS5611_ReadADC(ADC_Sel);
**=====================================================================================================*/
/*=====================================================================================================*/
static void MS5611_ReadADC( u8 ADC_Sel )
{
  u8 ReadADC[3] = {0};
  u8 WriteCMD = MS5611_ADC;

  I2C_WriteByte(MS5611_I2C_ADDR, &WriteCMD, 1);
  I2C_ReadByte(MS5611_I2C_ADDR, ReadADC, 3);

  COEFF.D[ADC_Sel] = (u32)(ReadADC[0]<<16 | ReadADC[1]<<8 | ReadADC[2]);
}
/*=====================================================================================================*/
/*=====================================================================================================*
**函數 : MS5611_Calculate
**功能 : MS5611 Calculate
**輸入 : COEFF
**輸出 : None
**使用 : MS5611_Calculate();
**=====================================================================================================*/
/*=====================================================================================================*/
static void MS5611_Calculate( void )
{
  COEFF.dT = (s32)(COEFF.D[2] - (s32)(COEFF.C[5]*POW_2_8));   // dT = D2 - C5*2^8
  COEFF.rTemp = (s32)(2000 + (s32)((COEFF.dT*COEFF.C[5])/POW_2_23));   // Temp = 2000 + dT*C5/2^23

  COEFF.OFF = (s64)(COEFF.C[2]*POW_2_16 + (COEFF.C[4]*COEFF.dT)/POW_2_7);   // OFF = C2*2^16 + (C4*dT)/2^7
  COEFF.SENS = (s64)(COEFF.C[1]*POW_2_15 + (COEFF.C[3]*COEFF.dT)/POW_2_8);  // SENS = C1*2^15 + (C3*dT)/2^8
  COEFF.rPress = (s32)(((COEFF.D[1]*COEFF.SENS)/POW_2_21 - COEFF.OFF)/POW_2_15);  // Press = (D1*SENS/2^21 - OFF)/2^15
}
/*=====================================================================================================*/
/*=====================================================================================================*
**函數 : MS5611_Read
**功能 : MS5611 Read
**輸入 : Baro, ADC_ConvMode
**輸出 : None
**使用 : MS5611_Read(Baro_Buf, MS5611_D1_OSR_4096);
**=====================================================================================================*/
/*=====================================================================================================*/
void MS5611_Read( s32 *Baro_Buf, u8 ADC_ConvMode )
{
  static MS5611_STATUS ReadSta = MS5611_ConvInit;

  switch(ReadSta) {
    case MS5611_ConvInit:
      MS5611_ConvADC(ADC_ConvMode);
      ReadSta = MS5611_ConvD1;
      break;
    case MS5611_ConvD1:
      MS5611_ReadADC(MS5611_ADC_D1);
      MS5611_ConvADC(ADC_ConvMode | 0x10);
      ReadSta = MS5611_ConvD2;
      break;
    case MS5611_ConvD2:
      MS5611_ReadADC(MS5611_ADC_D2);
      MS5611_ConvADC(ADC_ConvMode);
      MS5611_Calculate();
      Baro_Buf[0] = COEFF.rTemp;
      Baro_Buf[1] = COEFF.rPress;
      ReadSta = MS5611_ConvD1;
      break;
  }
}
/*=====================================================================================================*/
/*=====================================================================================================*/
